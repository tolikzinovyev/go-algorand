load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")
load("@bazel_gazelle//:def.bzl", "gazelle")

# gazelle:prefix github.com/karalabe/hid
gazelle(name = "gazelle")

cc_library(
    name = "libusb",
    hdrs = glob(["libusb/libusb/**/*"]),
)

cc_library(
    name = "hidapi",
    hdrs = glob(["hidapi/**/*"]),
)

go_library(
    name = "hid",
    srcs = [
        "hid.go",
        "hid_disabled.go",
        "hid_enabled.go",
        "wchar.go",
    ],
    cgo = True,
    clinkopts = select({
        "@io_bazel_rules_go//go/platform:darwin": [
            "-framework CoreFoundation -framework IOKit",
        ],
        "@io_bazel_rules_go//go/platform:linux": [
            "-lrt",
        ],
        "@io_bazel_rules_go//go/platform:windows": [
            "-lsetupapi",
        ],
        "//conditions:default": [],
    }),
    copts = select({
        "@io_bazel_rules_go//go/platform:android": [
            "-Ihidapi/hidapi",
            "-Ilibusb/libusb -DDEFAULT_VISIBILITY= -DOS_LINUX -D_GNU_SOURCE -DPOLL_NFDS_TYPE=int",
        ],
        "@io_bazel_rules_go//go/platform:darwin": [
            "-DOS_DARWIN",
            "-Ihidapi/hidapi",
        ],
        "@io_bazel_rules_go//go/platform:linux": [
            "-Iexternal/com_github_karalabe_hid/hidapi/hidapi",
            "-Iexternal/com_github_karalabe_hid/libusb/libusb -DDEFAULT_VISIBILITY= -DOS_LINUX -D_GNU_SOURCE -DPOLL_NFDS_TYPE=int",
        ],
        "@io_bazel_rules_go//go/platform:windows": [
            "-DOS_WINDOWS",
            "-Ihidapi/hidapi",
        ],
        "//conditions:default": [],
    }),
    cdeps = [
        ":hidapi",
        ":libusb",
    ],
    importpath = "github.com/karalabe/hid",
    visibility = ["//visibility:public"],
)

go_test(
    name = "hid_test",
    srcs = [
        "hid_test.go",
        "wchar_test.go",
    ],
    embed = [":hid"],
)
